generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  emailVerified DateTime?
  image        String?
  passwordHash String
  ownedCompany Company?         @relation("CompanyOwner")
  memberships  CompanyMember[]
  createdInvites CompanyInvite[] @relation("InviteCreator")
  accounts     Account[]
  sessions     Session[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Company {
  id        String   @id @default(cuid())
  name      String
  ownerId   String   @unique
  owner     User     @relation("CompanyOwner", fields: [ownerId], references: [id])
  members   CompanyMember[]
  invites   CompanyInvite[]
  managementCompanies ManagementCompany[]
  contacts  Contact[]
  contactCategories ContactCategory[]
  buildings Building[]
  units     Unit[]
  unitCategories UnitCategory[]
  unitStatuses UnitStatus[]
  unitEquipmentTypes UnitEquipmentType[]
  unitBrands UnitBrand[]
  mechanicLevels MechanicLevel[]
  mechanics Mechanic[]
  maintenances Maintenance[]
  maintenanceSequence MaintenanceSequence?
  inspectors Inspector[]
  inspections Inspection[]
  inspectionStatuses InspectionStatus[]
  inspectionResults InspectionResult[]
  inspectionSequence InspectionSequence?
  emergencyCallStatuses EmergencyCallStatus[]
  emergencyCalls EmergencyCall[]
  emergencyCallSequence EmergencyCallSequence?
  scheduledJobs ScheduledJob[]
  jobSequence JobSequence?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CompanyRole {
  OWNER
  ADMIN
  MEMBER
}

model CompanyMember {
  id        String      @id @default(uuid())
  companyId String
  userId    String
  role      CompanyRole @default(MEMBER)
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationPreferences NotificationPreferences?
  createdAt DateTime    @default(now())

  @@unique([companyId, userId])
  @@index([userId])
}

// Email notification preferences per user per company
model NotificationPreferences {
  id                    String   @id @default(uuid())
  companyMemberId       String   @unique
  companyMember         CompanyMember @relation(fields: [companyMemberId], references: [id], onDelete: Cascade)
  
  // Job notifications
  jobStatusUpdates      Boolean  @default(true)
  
  // Emergency notifications
  emergencyAlerts       Boolean  @default(true)
  
  // Inspection notifications
  inspectionReminders   Boolean  @default(true)
  
  // Summary notifications
  weeklySummary         Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model CompanyInvite {
  id              String      @id @default(uuid())
  companyId       String
  email           String
  role            CompanyRole
  token           String      @unique
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdByUserId String
  createdAt       DateTime    @default(now())

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User    @relation("InviteCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([email])
}

model ManagementCompany {
  id             String   @id @default(uuid())
  companyId      String
  name           String
  accountNumber  String?
  website        String?
  mainPhone      String?
  emergencyPhone String?
  notes          String?
  archivedAt     DateTime?
  contacts       Contact[]
  buildings      Building[]
  maintenances   Maintenance[]
  inspections    Inspection[]
  emergencyCalls EmergencyCall[]
  scheduledJobs  ScheduledJob[]
  portalAccess   PortalAccess[]
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([companyId, name])
  @@unique([companyId, accountNumber])
  @@index([companyId])
}

model Building {
  id                  String   @id @default(uuid())
  companyId           String
  managementCompanyId String
  name                String
  address             String
  localPhone          String?
  jurisdiction        String?
  notes               String?
  archivedAt          DateTime?
  company             Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  managementCompany   ManagementCompany  @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)
  units               Unit[]
  maintenances        Maintenance[]
  inspections         Inspection[]
  emergencyCalls      EmergencyCall[]
  scheduledJobs       ScheduledJob[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([companyId, managementCompanyId, name])
  @@index([companyId])
  @@index([managementCompanyId])
}

model UnitCategory {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  units       Unit[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model UnitStatus {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  units       Unit[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model UnitEquipmentType {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  units       Unit[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model UnitBrand {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  units       Unit[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model Unit {
  id                  String   @id @default(uuid())
  companyId           String
  buildingId          String
  identifier          String
  description         String?
  serialNumber        String?
  unitCategoryId      String
  unitStatusId        String
  equipmentTypeId     String
  brandId             String
  underContract       Boolean  @default(false)
  isActive            Boolean  @default(true)
  archivedAt          DateTime?
  agreementStartDate  DateTime?
  agreementEndDate    DateTime?
  phoneLineService    Boolean  @default(false)
  folderUrl           String?
  landings            Int?
  capacity            Int?
  floorLocation       Int?
  machineRoomLocation String?
  buildingNumber      String?
  certificateUrl      String?
  photoUrl            String?
  notes               String?
  company             Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  building            Building        @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unitCategory        UnitCategory    @relation(fields: [unitCategoryId], references: [id], onDelete: Cascade)
  unitStatus          UnitStatus      @relation(fields: [unitStatusId], references: [id], onDelete: Cascade)
  equipmentType       UnitEquipmentType @relation(fields: [equipmentTypeId], references: [id], onDelete: Cascade)
  brand               UnitBrand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  maintenances        Maintenance[]
  inspections         Inspection[]
  emergencyCalls      EmergencyCall[]
  scheduledJobs       ScheduledJob[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([companyId, buildingId, identifier])
  @@index([companyId])
  @@index([buildingId])
}

model Mechanic {
  id        String   @id @default(uuid())
  companyId String
  mechanicLevelId String?
  firstName String
  lastName  String
  email     String?
  phone     String?
  isActive  Boolean  @default(true)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  mechanicLevel MechanicLevel? @relation(fields: [mechanicLevelId], references: [id], onDelete: SetNull)
  maintenances Maintenance[]
  emergencyCalls EmergencyCall[]
  scheduledJobs ScheduledJob[]
  createdAt DateTime @default(now())

  @@unique([companyId, email])
  @@index([companyId])
}

model MechanicLevel {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  mechanics   Mechanic[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

enum MaintenanceStatus {
  OPEN
  COMPLETED
}

model Maintenance {
  id                  String   @id @default(uuid())
  companyId           String
  maintenanceCode     String
  managementCompanyId String
  buildingId          String
  unitId              String
  mechanicId          String?
  status              MaintenanceStatus @default(OPEN)
  maintenanceDate     DateTime
  notes               String?
  archivedAt          DateTime?
  company             Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  managementCompany   ManagementCompany  @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)
  building            Building           @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  mechanic            Mechanic?          @relation(fields: [mechanicId], references: [id], onDelete: SetNull)
  linkedJob           ScheduledJob?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([companyId, maintenanceCode])
  @@index([companyId])
  @@index([managementCompanyId])
  @@index([buildingId])
  @@index([unitId])
}

model MaintenanceSequence {
  id         String  @id @default(uuid())
  companyId  String  @unique
  nextNumber Int     @default(1)
  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Inspector {
  id          String   @id @default(uuid())
  companyId   String
  firstName   String
  lastName    String
  companyName String?
  email       String?
  phone       String?
  isActive    Boolean  @default(true)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inspections Inspection[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, email])
  @@index([companyId])
}

model InspectionStatus {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inspections Inspection[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model InspectionResult {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inspections Inspection[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model Inspection {
  id                  String   @id @default(uuid())
  companyId           String
  inspectionCode      String
  managementCompanyId String
  buildingId          String
  unitId              String
  inspectorId         String?
  inspectionStatusId  String
  inspectionResultId  String?
  inspectionDate      DateTime
  expirationDate      DateTime?
  reportUrl           String?
  notes               String?
  archivedAt          DateTime?
  company             Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  managementCompany   ManagementCompany @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)
  building            Building          @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  inspector           Inspector?        @relation(fields: [inspectorId], references: [id], onDelete: SetNull)
  inspectionStatus    InspectionStatus  @relation(fields: [inspectionStatusId], references: [id], onDelete: Cascade)
  inspectionResult    InspectionResult? @relation(fields: [inspectionResultId], references: [id], onDelete: SetNull)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([companyId, inspectionCode])
  @@index([companyId])
  @@index([managementCompanyId])
  @@index([buildingId])
  @@index([unitId])
}

model InspectionSequence {
  id         String  @id @default(uuid())
  companyId  String  @unique
  nextNumber Int     @default(1)
  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model EmergencyCallStatus {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  emergencyCalls EmergencyCall[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model EmergencyCall {
  id                    String   @id @default(uuid())
  companyId             String
  emergencyCode         String
  ticketNumber          String?
  managementCompanyId   String
  buildingId            String
  unitId                String
  mechanicId            String?
  emergencyCallStatusId String
  callInAt              DateTime
  completedAt           DateTime?
  issueDescription      String
  notes                 String?
  archivedAt            DateTime?
  company               Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  managementCompany     ManagementCompany @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)
  building              Building          @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                  Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  mechanic              Mechanic?         @relation(fields: [mechanicId], references: [id], onDelete: SetNull)
  emergencyCallStatus   EmergencyCallStatus @relation(fields: [emergencyCallStatusId], references: [id], onDelete: Cascade)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([companyId, emergencyCode])
  @@index([companyId])
  @@index([managementCompanyId])
  @@index([buildingId])
  @@index([unitId])
}

model EmergencyCallSequence {
  id         String  @id @default(uuid())
  companyId  String  @unique
  nextNumber Int     @default(1)
  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

// Phase 9: Scheduling & Dispatch

enum JobStatus {
  SCHEDULED
  EN_ROUTE
  ON_SITE
  COMPLETED
  CANCELLED
}

enum JobPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum JobType {
  MAINTENANCE
  INSPECTION
  EMERGENCY
  CALLBACK
  OTHER
}

model ScheduledJob {
  id                  String      @id @default(uuid())
  companyId           String
  jobCode             String
  title               String
  description         String?
  managementCompanyId String
  buildingId          String
  unitId              String?
  mechanicId          String?
  scheduledDate       DateTime
  scheduledStartTime  String?
  scheduledEndTime    String?
  status              JobStatus   @default(SCHEDULED)
  priority            JobPriority @default(NORMAL)
  jobType             JobType     @default(MAINTENANCE)
  maintenanceId       String?     @unique
  completedAt         DateTime?
  notes               String?
  archivedAt          DateTime?
  company             Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  managementCompany   ManagementCompany @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)
  building            Building          @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                Unit?             @relation(fields: [unitId], references: [id], onDelete: SetNull)
  mechanic            Mechanic?         @relation(fields: [mechanicId], references: [id], onDelete: SetNull)
  maintenance         Maintenance?      @relation(fields: [maintenanceId], references: [id], onDelete: SetNull)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([companyId, jobCode])
  @@index([companyId])
  @@index([managementCompanyId])
  @@index([buildingId])
  @@index([unitId])
  @@index([mechanicId])
  @@index([scheduledDate])
  @@index([status])
}

model JobSequence {
  id         String  @id @default(uuid())
  companyId  String  @unique
  nextNumber Int     @default(1)
  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model ContactCategory {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contacts    Contact[]
  createdAt   DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model Contact {
  id                  String   @id @default(uuid())
  companyId           String
  managementCompanyId String
  contactCategoryId   String
  firstName           String
  lastName            String
  email               String?
  phone               String?
  isPrimary           Boolean  @default(false)
  notes               String?
  archivedAt          DateTime?
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  managementCompany   ManagementCompany   @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)
  contactCategory     ContactCategory     @relation(fields: [contactCategoryId], references: [id], onDelete: Cascade)
  createdAt           DateTime @default(now())

  @@index([companyId])
  @@index([managementCompanyId])
  @@index([contactCategoryId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Customer Portal for building managers
model PortalAccess {
  id                  String   @id @default(uuid())
  token               String   @unique
  managementCompanyId String
  contactEmail        String
  contactName         String
  expiresAt           DateTime
  lastAccessedAt      DateTime?
  isActive            Boolean  @default(true)
  managementCompany   ManagementCompany @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)
  createdAt           DateTime @default(now())

  @@index([managementCompanyId])
  @@index([contactEmail])
}
